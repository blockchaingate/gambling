<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blackjack</title>
    <link rel="shortcut icon" href="favicon.ico" >
    
    <!-- style the webpage -->
    <style> 
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        background-image: url("bg.jpg");
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>

    <!-- Define and load in required functions -->
    <script src="bundle.js"></script>
    <!--<script src="CanvasInput-master/CanvasInput.js"></script>-->
    <script type="text/javascript">
      window.addEventListener("load", () =>{
        
        // Set up canvas
        let canvas = document.getElementById("myCanvas");
        let ctx = canvas.getContext("2d");

        let drawer = [];
        let buttons = [];
        let joinButton, createButton, testButton;
        let w,h;

				let contract;
				let games = [];
        let privateKey;
              
        // Function to remove an element from an array
        function arrRemove(arr,element) {
          let index = arr.indexOf(element);
          if (index != -1) {
            arr.splice(index,1);
          }
        }

        function addButton (_x,_y,_width,_height,_buttonColour,_textColour,_text,_func) {
          
          //Add button to array
          let button = {
            x: _x,
            y: _y,
            width: _width,
            height: _height,
            buttonColour: _buttonColour,
            textColour: _textColour,
            text: _text,
            func: _func
          };
          //button.func = _func.bind(button);
          buttons.push(button);
          return button;
        }

        // Resize canvas event listener function
        function resizeCanvas() {
          w = document.body.offsetWidth;
          h = document.body.offsetHeight;
          ctx.canvas.width  = w;
          ctx.canvas.height = h;
          ctx.translate(w/2,h/2);
          draw();
        }

        // Clicking event listener function
        function checkClicks(event) {
          for (let index = 0; index < buttons.length; index++) {
            if (
              event.x > buttons[index].x + w/2 && 
              event.x < buttons[index].x  + buttons[index].width + w/2 &&
              event.y > -h/3 + buttons[index].y + h/2 && 
              event.y < -h/3 + buttons[index].y + buttons[index].height + h/2
              ) {
              // Executes if button was clicked
              buttons[index].func();
              break;
            }
          }
        }       

        function setPrivateKey(txt) {
          privateKey = txt;
        }

        function showKey() {
          alert(privateKey);
          document.getElementById("Show Key").remove();
        }
        
        function drawTitle () {
          return function () {
            // Draw Title
            ctx.clearRect(-w/2,-h/2,w,h)
            ctx.font = "50px Algerian";
            ctx.fillStyle = "rgb(255,223,0)";
            ctx.textAlign = "center";
            ctx.fillText("Blackjack", 0, -h/3); 
          }
        }
        drawer.push(drawTitle());

        function drawButtons () {
          return function () {           
            // Render buttons
            for (let index = 0; index < buttons.length; index++) {
              ctx.fillStyle = buttons[index].buttonColour;
              ctx.fillRect(buttons[index].x, -h/3 + buttons[index].y, buttons[index].width, buttons[index].height);
              let fontSize = Math.min(buttons[index].width*2/buttons[index].text.length,buttons[index].height)*0.9;
							ctx.font = fontSize + "px Balthazar";
              ctx.fillStyle = buttons[index].textColour;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(buttons[index].text, buttons[index].x + buttons[index].width/2, -h/3 + buttons[index].y + buttons[index].height/2); 
            }
          }
        }
        drawer.push(drawButtons());

        // Function to make create and join game buttons
        function makeCreateJoinButtons () {
          createButton = addButton(10, 40, 200, 75, "#4CAF50","white","Create Game",() => {
            alert('Game Created!');
            makeContract();
            //arrRemove(buttons, joinButton);
						//arrRemove(buttons, createButton);
						buttons = [];
            makeBackButton();
          })

          joinButton = addButton(-210, 40, 200, 75, "#4CAF50","white","Join Game", async () => {
            alert('Button was clicked!');
            //arrRemove(buttons, joinButton);
						//arrRemove(buttons, createButton);
						buttons = [];
						games =	await getGames();
						console.log (games);
						console.log (games.length);

						for (let i = 0; i < games.length; i++) {
							addButton(-210, 40*(i+1), 100, 32.5, "#4CAF50","white",(games[i].minBet/Math.pow(10,18)).toString(),() => {
								buttons = [];
							});
						}
						makeBackButton();
          })
        }

        function makeBackButton () {
          testButton = addButton(-100, 40, 200, 75, "#4CAF50","white","back",() => {
						alert('Going back...');
						buttons = [];
            //arrRemove(buttons, testButton);
						makeCreateJoinButtons();
          })
        }

        // Draw all elements dynamic to window size
        function draw() {
          for (let i = 0; i < drawer.length; i++){
            drawer[i]();
          }
        }
        
        // Animate
        function step () {
          draw();
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);

        makeCreateJoinButtons();
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas, false);
        canvas.addEventListener('click', checkClicks);
      });
    </script>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <script>
      
    </script>
  </body>
</html>